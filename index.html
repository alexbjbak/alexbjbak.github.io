<!DOCTYPE html>
<html lang="en" itemscope itemtype="https://schema.org/Person">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title itemprop="name">Alex Bak</title>
<meta itemprop="jobTitle" content="Anesthesiology Resident">
<meta itemprop="affiliation" content="University of Toronto">
<meta itemprop="description" content="Alex Bak is an anesthesiology resident at the University of Toronto with interests in perioperative outcomes and biomedical engineering.">

<style>
:root {
    --bg-color: #fafafa;
    --text-color: #222;
    --card-bg: rgba(255, 255, 255, 0.7);
    --card-shadow: rgba(0,0,0,0.05);
    --card-border: rgba(255, 255, 255, 0.4);
    --subtitle-color: #666;
    --link-color: #444;
}
@media (prefers-color-scheme: dark) {
    :root {
        --bg-color: #121212;
        --text-color: #e0e0e0;
        --card-bg: rgba(30, 30, 30, 0.7);
        --card-shadow: rgba(0,0,0,0.4);
        --card-border: rgba(255, 255, 255, 0.1);
        --subtitle-color: #aaa;
        --link-color: #bbb;
    }
}
html {
    background-color: var(--bg-color);
}
body {
    font-family: 'Inter', Arial, sans-serif;
    margin: 0;
    padding: 0;
    color: var(--text-color);
    position: relative;
    overflow-x: hidden;
    min-height: 100vh;
}
#vanta-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
}
header {
    padding: 12px 30px;
    text-align: center;
    width: fit-content;
    margin: 20px auto 0;
    background: var(--card-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--card-border);
    border-radius: 12px;
    box-shadow: 0 4px 15px var(--card-shadow);
}
h1 { font-size: 1.8rem; margin: 0; }
.subtitle { color: var(--subtitle-color); font-size: 0.9rem; margin-top: 2px; }
.container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 30px;
}
.profile-card {
    background: var(--card-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--card-border);
    padding: 20px;
    border-radius: 14px;
    box-shadow: 0 4px 20px var(--card-shadow);
    text-align: center;
    display: flex;
    flex-direction: column;
    gap: 20px;
}
.profile-card .section {
    margin-bottom: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    padding: 0;
}
.profile-card img {
    width: 100%;
    height: 300px;
    object-fit: cover;
    border-radius: 10px;
}
.social {
    display: flex;
    gap: 12px;
    justify-content: center;
    align-items: center;
}
.social a {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    color: var(--link-color);
    text-decoration: none;
    transition: transform 0.2s ease, opacity 0.2s ease;
    border-radius: 8px;
}
.social a:hover {
    transform: translateY(-2px);
    opacity: 0.8;
}
.social-icon-svg {
    width: 24px;
    height: 24px;
    fill: currentColor;
}
.section {
    background: var(--card-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--card-border);
    padding: 15px 25px 25px;
    border-radius: 14px;
    box-shadow: 0 4px 20px var(--card-shadow);
    margin-bottom: 20px;
}
.section h2 { font-size: 1.3rem; margin-top: 0; margin-bottom: 15px; }
.section h4 { margin: 12px 0 5px; }
@media (max-width: 780px) {
    .container { grid-template-columns: 1fr; }

    /* Move news to the end */
    .news-section {
        order: 1;
    }
}
#pub-list a.pub-entry {
    display: block;
    margin: 10px 0;
    line-height: 1.4;
    font-size: 0.95rem;
    color: var(--text-color);
    text-decoration: none;
    padding: 8px 12px;
    margin: 8px -12px;
    border-radius: 8px;
    transition: background-color 0.2s ease;
}
#pub-list.collapsed .pub-entry-container:nth-child(n+11) {
    display: none;
}
#pub-list .pub-entry-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    margin: 8px -12px;
    border-radius: 8px;
    transition: background-color 0.2s ease;
}
#pub-list .pub-entry-container:hover {
    background-color: rgba(102, 126, 234, 0.08);
}
#pub-list .pub-entry-container a.pub-entry {
    flex-grow: 1;
    margin: 0;
    line-height: 1.4;
    font-size: 0.95rem;
    color: var(--text-color);
    text-decoration: none;
    padding-right: 15px;
}
#pub-list .pub-entry-container:hover a.pub-entry strong {
    color: #667eea;
    background-color: rgba(102, 126, 234, 0.15);
}
#pub-list .pub-entry-container strong {
    transition: color 0.2s ease, background-color 0.2s ease;
    border-radius: 3px;
    padding: 1px 3px;
    margin: -1px -3px;
}
#pub-controls { display: flex; gap: 10px; align-items: center; margin-bottom: 12px; }
#refresh-btn {
    padding: 6px 10px; border-radius: 8px; border: 1px solid #ddd;
    background: var(--card-bg); cursor: pointer; color: var(--text-color);
}
#last-updated { color: var(--subtitle-color); font-size: 0.9rem; }
a { color: var(--link-color); text-decoration: none; }


/* News Grid */
#news-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
  gap: 12px;
  justify-content: center;
}

.news-card { display: flex; flex-direction: column; align-items: center; }

.news-card p {
  font-size: 0.9rem;
  color: var(--text-color);
  margin: 8px 0 0;
  text-align: center; /* center the text */
}

/* === GRAYSCALE + HOVER TO COLOR === */
.news-card img {
  border-radius: 8px;
  width: 100%;
  height: 150px;
  object-fit: cover;
  filter: grayscale(100%);
  transition: filter 0.3s ease;
}

.news-card:hover img {
  filter: grayscale(0%);
}

/* Globe Widget */
.globe-section {
    position: relative;
}
.globe-container {
    position: relative;
    width: 100%;
    height: 280px;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 10px 0 5px 0;
    border-radius: 10px;
    overflow: hidden;
}
#globe-container {
    width: 100%;
    height: 100%;
    cursor: grab;
}
#globe-container:active {
    cursor: grabbing;
}

/* Globe Legend */
.globe-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
    margin-top: 12px;
}
.legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.7rem;
    color: var(--subtitle-color);
    padding: 3px 8px;
    background: var(--bg-color);
    border-radius: 12px;
}
.legend-emoji {
    font-size: 0.9rem;
}
.legend-color {
    width: 10px;
    height: 10px;
    border-radius: 3px;
}

/* Adventure Stats (now part of globe section) */
.globe-section .stats-grid {
    display: flex;
    gap: 8px;
    margin-top: 15px;
    width: 100%;
}
.globe-section .stat-card {
    flex: 1;
    min-width: 0;
    background: var(--card-bg);
    border-radius: 12px;
    box-shadow: 0 2px 8px var(--card-shadow);
    padding: 6px 4px;
    text-align: center;
    border: 1px solid var(--card-border);
}
.globe-section .stat-label {
    color: var(--subtitle-color);
    font-size: 0.7rem;
    margin-bottom: 3px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 3px;
    white-space: nowrap;
}
.stat-emoji {
    font-size: 0.9rem;
    line-height: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1em;
    height: 1em;
}
.globe-section .stat-number {
    font-size: 1rem;
    font-weight: bold;
    color: var(--text-color);
}

@media (max-width: 780px) {
    .globe-section .stats-grid {
        flex-direction: column;
        gap: 10px;
    }
}

/* Globe tooltip */
.globe-tooltip {
    position: absolute;
    padding: 6px 12px;
    background: rgba(0,0,0,0.8);
    color: white;
    border-radius: 6px;
    font-size: 0.75rem;
    pointer-events: none;
    z-index: 100;
    white-space: nowrap;
}

/* Timeline */
.timeline {
    position: relative;
    padding-left: 0;
}
.timeline-item {
    position: relative;
    margin-bottom: 16px;
    padding: 16px 20px;
    border-radius: 12px;
    background: var(--card-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--card-border);
    border-left: 4px solid transparent; /* Unified border width for alignment */
    box-shadow: 0 2px 8px var(--card-shadow);
    transition: all 0.3s ease;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    justify-content: center;
    min-height: 60px;
}
.timeline-item:last-child {
    margin-bottom: 0;
}
.timeline-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px var(--card-shadow);
    border-color: rgba(255, 255, 255, 0.3);
    border-left-width: 4px; /* Maintain alignment on hover */
}
/* Year Badge Approach */
.timeline-year {
    display: inline-block;
    width: fit-content;
    padding: 2px 10px;
    background: rgba(0, 0, 0, 0.05);
    border-radius: 20px;
    font-size: 0.7rem;
    color: var(--subtitle-color);
    font-weight: 700;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: 1px solid transparent;
    text-align: left;
}
@media (prefers-color-scheme: dark) {
    .timeline-year {
        background: rgba(255, 255, 255, 0.05);
    }
}
/* Current/Experience items */
.timeline-item.current {
    background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(255, 107, 107, 0.05));
    border-color: rgba(255, 107, 107, 0.4);
    border-left: 4px solid #ff6b6b;
}
.timeline-item.current .timeline-year {
    background: #ff6b6b;
    color: white;
}
.timeline-item.current .timeline-title {
    font-size: 1.15rem;
}
.timeline-item.current .timeline-org {
    font-size: 0.9rem;
}
/* Education items */
.timeline-item.education {
    border-left: 4px solid #4ecdc4;
    background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(78, 205, 196, 0.05));
    border-color: rgba(78, 205, 196, 0.4);
}
.timeline-item.education .timeline-year {
    color: #4ecdc4;
    border-color: rgba(78, 205, 196, 0.3);
}
/* Research items */
.timeline-item.research {
    border-left: 4px solid #a78bfa;
    background: linear-gradient(135deg, rgba(167, 139, 250, 0.1), rgba(167, 139, 250, 0.05));
    border-color: rgba(167, 139, 250, 0.4);
}
.timeline-item.research .timeline-year {
    color: #a78bfa;
    border-color: rgba(167, 139, 250, 0.3);
}
/* Expanded state highlight */
.timeline-item.expanded {
    box-shadow: 0 4px 20px var(--card-shadow);
}
.timeline-title {
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 4px;
    line-height: 1.3;
    text-align: left;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
}
.timeline-emoji {
    font-size: 1.2rem;
    flex-shrink: 0;
}
.timeline-org {
    color: var(--subtitle-color);
    font-size: 0.8rem;
    text-align: left;
}
.timeline-details {
    color: var(--subtitle-color);
    font-size: 0.78rem;
    line-height: 1.5;
    margin-top: 0;
    padding-top: 0;
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transition: all 0.3s ease;
    text-align: left;
}
.timeline-item.expanded .timeline-details {
    max-height: 300px;
    opacity: 1;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid var(--card-shadow);
}
/* Size variants based on importance */
.timeline-item.large {
    min-height: 70px;
    padding: 16px 20px;
}
.timeline-item.large .timeline-title {
    font-size: 1.1rem;
}
.timeline-item.medium {
    min-height: 60px;
    padding: 16px 20px;
}
.timeline-item.medium .timeline-title {
    font-size: 0.95rem;
}
.timeline-item.small {
    min-height: 50px;
    padding: 16px 20px;
    margin-bottom: 12px;
}
.timeline-item.small .timeline-title {
    font-size: 0.85rem;
}
.timeline-item.small .timeline-year {
    font-size: 0.65rem;
}
.timeline-item.small .timeline-org {
    font-size: 0.75rem;
}

</style>
</head>
<body>
<div id="vanta-bg"></div>
<header>
    <h1 itemprop="name">Alex Bak</h1>
    <div class="subtitle">Toronto ‚Ä¢ Canada</div>
</header>
<div class="container">
<aside>
    <div class="profile-card">
        <img src="images/headshot1.jpeg" alt="Alex B Bak headshot" itemprop="image">
        <div class="social">
            <a href="https://scholar.google.com/citations?user=TnT6AcUAAAAJ&hl=en" target="_blank" rel="noopener" title="Google Scholar">
                <svg class="social-icon-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M5.242 13.769L0 9.5 12 0l12 9.5-5.242 4.269C17.548 11.249 14.978 9.5 12 9.5c-2.977 0-5.548 1.748-6.758 4.269zM12 10a7 7 0 1 0 0 14 7 7 0 0 0 0-14z" fill="currentColor"/>
                </svg>
            </a>
            <a href="https://www.linkedin.com/in/alexbbak/" target="_blank" rel="noopener" title="LinkedIn">
                <svg class="social-icon-svg" height="512" viewBox="0 0 512 512" width="512" xmlns="http://www.w3.org/2000/svg">
                    <rect height="512" rx="64" ry="64" width="512" x="0" y="0" fill="currentColor"/>
                    <g transform="matrix(1.5537946,0,0,1.5537946,-140.87332,-132.64552)">
                        <rect height="166.021" width="55.194" x="129.957" y="200.35699" fill="var(--card-bg)"/>
                        <path d="m 157.927,120.303 c -18.884,0 -31.222,12.415 -31.222,28.687 0,15.93 11.963,28.687 30.491,28.687 h 0.357 c 19.245,0 31.224,-12.757 31.224,-28.687 -0.357,-16.272 -11.978,-28.687 -30.85,-28.687 z" fill="var(--card-bg)"/>
                        <path d="m 320.604,196.453 c -29.277,0 -42.391,16.101 -49.734,27.41 v -23.506 h -55.18 c 0.732,15.573 0,166.021 0,166.021 h 55.179 V 273.66 c 0,-4.963 0.357,-9.924 1.82,-13.471 3.982,-9.911 13.068,-20.178 28.313,-20.178 19.959,0 27.955,15.23 27.955,37.539 v 88.828 h 55.182 v -95.206 c 0,-50.996 -27.227,-74.719 -63.535,-74.719 z" fill="var(--card-bg)"/>
                    </g>
                </svg>
            </a>
            <a href="#" id="contact-link" title="Email Me">
                <svg class="social-icon-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" fill="currentColor"/>
                </svg>
            </a>
        </div>

        <!-- News Section -->
        <section class="section news-section" id="news">
          <h2>In the News</h2>
          <div id="news-grid"></div>
        </section>

        <!-- Globe Widget - Places I've Been -->
        <section class="section globe-section">
            <h2>Adventure Stats</h2>
            <div class="globe-container">
                <div id="globe-container"></div>
            </div>
            <!-- Adventure Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label"><span class="stat-emoji">üåç</span> Countries</div>
                    <div class="stat-number" id="countries-counter">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label"><span class="stat-emoji">üéø</span> Slopes</div>
                    <div class="stat-number" id="ski-counter">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label"><span class="stat-emoji">ü§ø</span> Dives</div>
                    <div class="stat-number" id="dives-counter">0</div>
                </div>
            </div>
        </section>
    </div>
</aside>

<main>
<section class="section" itemprop="description">
    <h2>Bio</h2>
    <p>Alex Bak is a physician, researcher, and digital health innovator with a focus on improving care for people living with chronic pain, disability, and those undergoing surgery. His work lies at the intersection of pain, mood, evaluation, and biomedical data science.
        His research uses advanced modelling on large-scale data to understand how these conditions and novel therapies shape long-term health.</p>
    <p>
        Alex has received broad international recognition for his academic contributions, delivering over 25 podium presentations at premier scientific meetings worldwide. His work has earned several distinctions, including back-to-back Best Papers Awards at the North American Spine Society meetings (2022, 2023) and a finalist placement for the Canadian Orthopaedic Association's Founder's Medal. His work has been further highlighted by honours such as the Anesthesia Patient Safety Foundation Award and the Canadian Anesthesiologists' Society Abstract Award.
        His work has been funded by the Canadian Anesthesia Research Foundation, Institute of Medical Science and the University of Toronto Faculty of Medicine.
    </p>
        <p>In 2024, Alex was elected co-Chair of the Resident Section of the Canadian Anesthesiologists' Society (CAS) and a member of the CAS Clinical Practice Guidelines Committee. Subsequently, he was appointed as board member of the CAS Board of Directors.</p>

    <p>Alex grew up in Seoul and rural South Korea, later moving to Southern Ontario. He completed medical school and advanced training in biomedical engineering at the University of Toronto, where he is currently a resident physician in the Deparmtent of Anesthesiology and Pain Medicine.</p>
</section>

<section class="section">
    <h2>Timeline</h2>
    <div class="timeline" id="timeline">
        <div class="timeline-item current large">
            <div class="timeline-year">Jul 2024 ‚Äì Present</div>
            <div class="timeline-title">Resident Physician, Anesthesiology <span class="timeline-emoji">ü©∫</span></div>
            <div class="timeline-org">University of Toronto</div>
            <div class="timeline-details">
                ‚Ä¢ Board Representative, Canadian Anesthesiologists' Society Board of Directors<br>
                ‚Ä¢ Co-chair, Canadian Anesthesiologists' Society Resident Section<br>
                ‚Ä¢ Canadian Anesthesiologists' Society Clinical Practice Guidelines Committee
            </div>
        </div>
        <div class="timeline-item research medium">
            <div class="timeline-year">Nov 2020 ‚Äì Present</div>
            <div class="timeline-title">AI Research Fellow <span class="timeline-emoji">üî¨</span></div>
            <div class="timeline-org">University Health Network</div>
            <div class="timeline-details">Funding: AI Studentship, Temerty Centre for AI Research and Education in Medicine</div>
        </div>
        <div class="timeline-item education medium">
            <div class="timeline-year">2024</div>
            <div class="timeline-title">MD in Medicine <span class="timeline-emoji">üéì</span></div>
            <div class="timeline-org">University of Toronto</div>
            <div class="timeline-details">
                ‚Ä¢ Founder, Temerty Alpine (Ski and Snowboard) Club<br>
                ‚Ä¢ Computing for Medicine Certificate, Department of Computer Science
            </div>
        </div>
        <div class="timeline-item education small">
            <div class="timeline-year">2023</div>
            <div class="timeline-title">MEng in Biomedical Engineering <span class="timeline-emoji">üéì</span></div>
            <div class="timeline-org">University of Toronto</div>
            <div class="timeline-details">Focus on biomedical data science and machine learning</div>
        </div>
        <div class="timeline-item education small">
            <div class="timeline-year">2020</div>
            <div class="timeline-title">BHSc (Honours) in Health Sciences <span class="timeline-emoji">üéì</span></div>
            <div class="timeline-org">McMaster University</div>
            <div class="timeline-details">
                Bachelor of Health Sciences (Honours) Program<br>
                ‚Ä¢ summa cum laude<br>
                ‚Ä¢ Grand Challenges Scholar, National Academy of Engineering
                </div>
        </div>
        <div class="timeline-item research small">
            <div class="timeline-year">Sep 2017 ‚Äì May 2020</div>
            <div class="timeline-title">R&D Lead, Virtual Reality Devices <span class="timeline-emoji">üî¨</span></div>
            <div class="timeline-org">McMaster University Department of Medicine</div>
            <div class="timeline-details">
                ‚Ä¢ Created portable, affordable VR tool for anatomy education in low-resource settings<br>
                ‚Ä¢ Led technology validation with randomized, double-blind controlled trial
            </div>
        </div>
    </div>
</section>

<section class="section" id="publications">
    <h2>Publications</h2>
    <div id="pub-controls">
        <button id="refresh-btn" title="Force refresh publications">Refresh</button>
        <div id="last-updated">Last updated: <span id="last-updated-time">‚Äî</span></div>
    </div>
    <div id="pub-list" class="collapsed">Loading publications...</div>
    <div id="show-more-container" style="display: none;">
        <button id="show-more-btn">Show More</button>
    </div>
</section>

<!-- Paper Preview Modal -->
<div id="paper-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <div id="modal-scroll-wrapper">
            <div id="modal-body">
                <h3 id="modal-title"></h3>
                <p id="modal-authors" class="modal-meta"></p>
                <p id="modal-journal" class="modal-meta"></p>
                <div id="modal-abstract-container">
                    <h4>Abstract</h4>
                    <div id="modal-abstract"></div>
                </div>
                <div class="modal-actions">
                    <a id="modal-link" href="#" target="_blank" rel="noopener" class="button small alt">Open in New Tab</a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 20000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: hidden; /* Prevent background scroll chaining */
    background-color: rgba(0, 0, 0, 0.5); /* Slightly lighter overlay */
}
.modal-content {
    background: rgba(25, 25, 25, 0.65); /* More transparent dark base */
    backdrop-filter: blur(25px) saturate(160%);
    -webkit-backdrop-filter: blur(25px) saturate(160%);
    margin: 5% auto;
    padding: 20px 0; /* Vertical padding for scrollbar buffer */
    border-radius: 20px;
    width: 85%;
    max-width: 850px;
    position: relative;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
    color: #fff;
    border: 1px solid rgba(255, 255, 255, 0.18);
    transition: transform 0.3s ease-out;
    overflow: hidden; /* Prevent direct content spill */
    display: flex;
    flex-direction: column;
}
#modal-scroll-wrapper {
    padding: 10px 30px 30px; /* Internal padding for content */
    overflow-y: auto;
    flex-grow: 1;
    -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    overscroll-behavior: contain; /* Prevent scroll chaining to background */
    /* Smooth fade at boundaries */
    -webkit-mask-image: linear-gradient(to bottom, transparent, black 30px, black calc(100% - 30px), transparent);
    mask-image: linear-gradient(to bottom, transparent, black 30px, black calc(100% - 30px), transparent);
}
.close-modal {
    color: #ccc;
    position: absolute;
    right: 20px;
    top: 15px;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
}
.close-modal:hover { color: #fff; transform: scale(1.1); }
.modal-meta { font-size: 0.9em; color: #aaa; margin-bottom: 5px !important; }
#modal-title { margin-bottom: 20px; color: #fff; font-size: 1.5em; line-height: 1.3; font-weight: 700; }
#modal-abstract-container h4 { margin: 25px 0 10px 0; font-size: 1.1em; color: #ff6b6b; text-transform: uppercase; letter-spacing: 1px; }
#modal-abstract { line-height: 1.7; font-size: 1em; text-align: justify; color: #ddd; }
.modal-actions { margin-top: 35px; display: flex; justify-content: center; }
.modal-actions .button {
    border-radius: 8px;
    transition: all 0.3s ease;
    padding: 0.8em 2.5em !important;
    height: auto !important;
    line-height: 1.5 !important;
    font-size: 0.9em !important;
    font-family: inherit !important;
    text-align: center;
}
#modal-link { background-color: #d52349; color: #fff; border: none; text-decoration: none !important; display: inline-block; }
#modal-link:hover { background-color: #f03e66; box-shadow: 0 4px 15px rgba(213, 35, 73, 0.4); }

.pub-entry-container { 
    margin: 8px -12px;
    border-radius: 8px;
    transition: background-color 0.2s ease;
}
.pub-entry-container:hover {
    background-color: rgba(102, 126, 234, 0.12);
}
.pub-entry-container a.pub-entry {
    display: block;
    width: 100%;
    padding: 12px 15px;
    text-decoration: none !important;
    cursor: pointer;
}
.preview-btn {
    display: none !important;
}
@media screen and (max-width: 736px) {
    .modal-content { 
        width: calc(100% - 40px); /* 20px buffer on each side */
        margin: 20px auto 60px;   /* Large 60px bottom margin to clear Safari UI */
        padding: 30px 0;          /* Increased vertical padding for scrollbar buffer */
        border-radius: 15px;
        max-height: calc(100vh - 120px); /* Ends much earlier to clear home indicator */
        overflow: hidden;         /* Contain the scroll wrapper */
    }
    #modal-scroll-wrapper {
        padding: 5px 20px 20px;   /* Adjusted internal padding */
    }
    .modal-actions { flex-direction: column; }
    #modal-title { font-size: 1.1em; margin-bottom: 12px; }
    #modal-abstract { font-size: 0.85em; line-height: 1.6; }
    .modal-meta { font-size: 0.75em; }
    #modal-abstract-container h4 { font-size: 0.9em; margin-top: 15px; }
    .close-modal { top: 5px; right: 10px; font-size: 22px; padding: 10px; z-index: 10; } 
}
</style>

</main>
</div>

<!-- Vanta.js Background -->
<script src="https://unpkg.com/three@0.134.0/build/three.min.js" defer></script>
<script src="https://unpkg.com/vanta@0.5.24/dist/vanta.cells.min.js" defer></script>

<!-- Globe.gl Library -->
<script src="https://unpkg.com/globe.gl@2.27.0/dist/globe.gl.min.js" defer></script>

<script>
// Global error logging
window.onerror = function(msg, url, lineNo, columnNo, error) {
    console.error('Global Error: ' + msg + ' at ' + url + ':' + lineNo);
    return false;
};

document.addEventListener('DOMContentLoaded', function() {
    var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    // Helper for safe localStorage access
    function isLocalStorageAvailable() {
        try {
            var storage = window.localStorage, x = '__storage_test__';
            storage.setItem(x, x);
            storage.removeItem(x);
            return true;
        } catch (e) { return false; }
    }
    var storageAvailable = isLocalStorageAvailable();

    // ============================================
    // VANTA.JS CELLS BACKGROUND
    // ============================================
    var vantaEffect = null;
    var vantaColors = {
        'current': { color1: 0xff6b6b, color2: 0xffa5a5 },
        'research': { color1: 0xa78bfa, color2: 0xc4b5fd },
        'education': { color1: 0x4ecdc4, color2: 0x86efac },
        'default': { color1: 0x008c8c, color2: 0xf2e735 }
    };
    var currentVantaColors = { 
        color1: vantaColors.default.color1, 
        color2: vantaColors.default.color2 
    };
    var colorTransitionId = null;

    function lerpColor(start, end, t) {
        var r1 = (start >> 16) & 0xff, g1 = (start >> 8) & 0xff, b1 = start & 0xff;
        var r2 = (end >> 16) & 0xff, g2 = (end >> 8) & 0xff, b2 = end & 0xff;
        var r = Math.round(r1 + (r2 - r1) * t);
        var g = Math.round(g1 + (g2 - g1) * t);
        var b = Math.round(b1 + (b2 - b1) * t);
        return (r << 16) | (g << 8) | b;
    }

    function animateVantaColors(targetColors, duration) {
        if (colorTransitionId) cancelAnimationFrame(colorTransitionId);
        var startColor1 = currentVantaColors.color1;
        var startColor2 = currentVantaColors.color2;
        var startTime = performance.now();

        function step(now) {
            var elapsed = now - startTime;
            var t = Math.min(elapsed / duration, 1);
            // Ease in out quad
            var easeT = t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
            
            currentVantaColors.color1 = lerpColor(startColor1, targetColors.color1, easeT);
            currentVantaColors.color2 = lerpColor(startColor2, targetColors.color2, easeT);
            
            if (vantaEffect) {
                vantaEffect.setOptions({
                    color1: currentVantaColors.color1,
                    color2: currentVantaColors.color2
                });
            }
            
            if (t < 1) {
                colorTransitionId = requestAnimationFrame(step);
            } else {
                colorTransitionId = null;
            }
        }
        colorTransitionId = requestAnimationFrame(step);
    }

    if (typeof VANTA !== 'undefined' && VANTA.CELLS) {
        try {
            var isDarkVanta = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            vantaEffect = VANTA.CELLS({
                el: "#vanta-bg",
                mouseControls: !isMobile,
                touchControls: true,
                gyroControls: false,
                minHeight: 200.00,
                minWidth: 200.00,
                scale: 1.00,
                color1: vantaColors.default.color1,
                color2: vantaColors.default.color2,
                size: isMobile ? 1.20 : 1.50,
                speed: isMobile ? 0.70 : 1.00
            });
        } catch (err) {
            console.warn("Vanta background failed to initialize:", err);
            var bgEl = document.getElementById('vanta-bg');
            if (bgEl) {
                var isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                bgEl.style.background = isDark ? '#121212' : '#fafafa';
            }
        }
    }

    // ============================================
    // GLOBE.GL ADVANCED WIDGET
    // ============================================
    var container = document.getElementById('globe-container');
    if (container) {
        var isDarkGlobe = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        // ====== ADVENTURE DATA ======
        // Countries to highlight (visited)
       const visitedCountries = [
              { country: 'Canada', code: 'CAN', color: '#ffe66d', activity: 'home' },
            
              // Dived
              { country: 'Philippines', code: 'PHL', color: '#ff6b6b', activity: 'dived' },
              { country: 'Malaysia', code: 'MYS', color: '#ff6b6b', activity: 'dived' }, // Malaysian Borneo
              { country: 'Thailand', code: 'THA', color: '#ff6b6b', activity: 'dived' },
              { country: 'Indonesia', code: 'IDN', color: '#ff6b6b', activity: 'dived' },
            
              // Visited
              { country: 'Portugal', code: 'PRT', color: '#4ecdc4', activity: 'visited' },
              { country: 'Vietnam', code: 'VNM', color: '#4ecdc4', activity: 'visited' },
              { country: 'South Korea', code: 'KOR', color: '#4ecdc4', activity: 'visited' },
              { country: 'United States', code: 'USA', color: '#4ecdc4', activity: 'visited' },
              { country: 'Taiwan', code: 'TWN', color: '#4ecdc4', activity: 'visited' },
              { country: 'Colombia', code: 'COL', color: '#4ecdc4', activity: 'visited' },
              { country: 'Costa Rica', code: 'CRI', color: '#4ecdc4', activity: 'visited' },
              { country: 'France', code: 'FRA', color: '#4ecdc4', activity: 'visited' },
              { country: 'Iceland', code: 'ISL', color: '#4ecdc4', activity: 'visited' },
              { country: 'Japan', code: 'JPN', color: '#4ecdc4', activity: 'visited' },
              { country: 'North Korea', code: 'PRK', color: '#4ecdc4', activity: 'visited' },
              { country: 'Peru', code: 'PER', color: '#4ecdc4', activity: 'visited' },
              { country: 'Singapore', code: 'SGP', color: '#4ecdc4', activity: 'visited' },
              { country: 'Switzerland', code: 'CHE', color: '#4ecdc4', activity: 'visited' },
              { country: 'United Kingdom', code: 'GBR', color: '#4ecdc4', activity: 'visited' }
            ];

        var adventureMarkers = [
            { name: 'Philippines', lat: 14.5995, lng: 120.9842, emoji: 'ü§ø', activity: 'Scuba diving in Philippines', color: '#ff6b6b' },
            { name: 'Malaysia', lat: 4.1147, lng: 118.6287, emoji: 'ü§ø', activity: 'Scuba diving in Sipadan, Malaysia', color: '#ff6b6b' },
            { name: 'Thailand', lat: 8.6500, lng: 97.6500, emoji: 'ü§ø', activity: 'Scuba diving in Similan, Thailand', color: '#ff6b6b' },
            { name: 'Indonesia', lat: -8.5833, lng: 119.4833, emoji: 'ü§ø', activity: 'Scuba diving in Komodo, Indonesia', color: '#ff6b6b' }

            /*
            // Examples on how to set up markers:
            { name: 'Toronto', lat: 43.6532, lng: -79.3832, emoji: 'üè†', activity: 'Home', color: '#ffe66d' },
            { name: 'Manila', lat: 14.5995, lng: 120.9842, emoji: 'ü§ø', activity: 'Scuba diving in Philippines', color: '#ff6b6b' },
            { name: 'Porto', lat: 41.1579, lng: -8.6291, emoji: 'üìç', activity: 'Visited Porto', color: '#4ecdc4' },
            { name: 'Ho Chi Minh', lat: 10.8231, lng: 106.6297, emoji: 'üìç', activity: 'Visited Vietnam', color: '#4ecdc4' },
            { name: 'Seoul', lat: 37.5665, lng: 126.9780, emoji: 'üìç', activity: 'Visited South Korea', color: '#4ecdc4' },
            { name: 'California', lat: 36.7783, lng: -119.4179, emoji: 'üìç', activity: 'Visited California', color: '#4ecdc4' },
            { name: 'Taipei', lat: 25.0330, lng: 121.5654, emoji: 'üìç', activity: 'Visited Taiwan', color: '#4ecdc4' }
            */
        ];

        if (typeof Globe === 'function') {
            try {
                var globe = Globe()
                    .globeImageUrl(isDarkGlobe
                        ? 'https://unpkg.com/three-globe/example/img/earth-dark.jpg'
                        : 'https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
                    .bumpImageUrl('https://unpkg.com/three-globe/example/img/earth-topology.png')
                    .backgroundImageUrl(isDarkGlobe
                        ? 'https://unpkg.com/three-globe/example/img/night-sky.png'
                        : null)
                    .backgroundColor(isDarkGlobe ? '#1e1e1e' : '#fafafa')
                    .showAtmosphere(true)
                    .atmosphereColor(isDarkGlobe ? '#4ecdc4' : '#3a86ff')
                    .atmosphereAltitude(0.15)
                    .width(container.offsetWidth)
                    .height(container.offsetHeight);

                globe(container);

                if (globe.controls()) {
                    globe.controls().autoRotate = true;
                    globe.controls().autoRotateSpeed = isMobile ? 0.15 : 0.3;
                    globe.controls().enableZoom = true;
                    globe.controls().minDistance = 150;
                    globe.controls().maxDistance = 400;
                }

                fetch('https://raw.githubusercontent.com/vasturiano/globe.gl/master/example/datasets/ne_110m_admin_0_countries.geojson')
                    .then(function(res) { return res.json(); })
                    .then(function(countries) {
                        var visitedCodes = visitedCountries.map(function(c) { return c.code; });
                        globe
                            .polygonsData(countries.features.filter(function(d) {
                                return visitedCodes.indexOf(d.properties.ISO_A3) !== -1;
                            }))
                            .polygonCapColor(function(feat) {
                                var visited = visitedCountries.find(function(c) { return c.code === feat.properties.ISO_A3; });
                                return visited ? visited.color + 'cc' : 'rgba(100,100,100,0.3)';
                            })
                            .polygonSideColor(function() { return 'rgba(100,100,100,0.1)'; })
                            .polygonStrokeColor(function() { return '#fff'; })
                            .polygonAltitude(0.01)
                            .polygonLabel(function(feat) {
                                var visited = visitedCountries.find(function(c) { return c.code === feat.properties.ISO_A3; });
                                var activity = visited ? visited.activity : null;
                                var color = visited ? visited.color : null;
                                var emoji = activity === 'dived' ? 'ü§ø' : (activity === 'home' ? 'üè†' : '‚úàÔ∏è');
                                return '<div style="background:rgba(0,0,0,0.8);color:white;padding:8px 12px;border-radius:8px;font-size:12px;">' +
                                       '<b>' + emoji + ' ' + feat.properties.NAME + '</b><br/>' +
                                       '<span style="color:' + (color || '#ccc') + '">' + (activity || 'Visited') + '</span></div>';
                            })
                            .onPolygonClick(function(polygon, event, coords) {
                                globe.pointOfView({ lat: coords.lat, lng: coords.lng, altitude: 1.5 }, 1000);
                            })
                            .onPolygonHover(function(polygon) {
                                container.style.cursor = polygon ? 'pointer' : 'grab';
                            });
                    });

                globe
                    .htmlElementsData(adventureMarkers)
                    .htmlElement(function(d) {
                        var el = document.createElement('div');
                        el.style.cssText = 'position: relative; pointer-events: auto;';
                        el.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;cursor:pointer;position:absolute;left:50%;top:50%;transform:translate(-50%,-100%);">' +
                                       '<span style="font-size:20px;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.5));transition:transform 0.2s;" class="marker-emoji">' + d.emoji + '</span>' +
                                       '<span style="background:rgba(0,0,0,0.7);color:white;padding:2px 6px;border-radius:4px;font-size:8px;margin-top:1px;white-space:nowrap;">' + d.name + '</span></div>';

                        el.onmouseenter = function() {
                            var markerEmoji = el.querySelector('.marker-emoji');
                            if (markerEmoji) markerEmoji.style.transform = 'scale(1.3)';
                        };
                        el.onmouseleave = function() {
                            var markerEmoji = el.querySelector('.marker-emoji');
                            if (markerEmoji) markerEmoji.style.transform = 'scale(1)';
                        };
                        el.onclick = function(event) {
                            globe.pointOfView({ lat: d.lat, lng: d.lng, altitude: 1.2 }, 1000);
                            showTooltip(d.activity, event);
                        };
                        return el;
                    })
                    .htmlLat(function(d) { return d.lat; })
                    .htmlLng(function(d) { return d.lng; })
                    .htmlAltitude(0.01);

                function showTooltip(text, event) {
                    var existing = document.querySelector('.globe-tooltip');
                    if (existing) existing.parentNode.removeChild(existing);
                    var tooltip = document.createElement('div');
                    tooltip.className = 'globe-tooltip';
                    tooltip.textContent = text;
                    tooltip.style.left = event.clientX + 'px';
                    tooltip.style.top = (event.clientY - 40) + 'px';
                    document.body.appendChild(tooltip);
                    setTimeout(function() { if (tooltip.parentNode) tooltip.parentNode.removeChild(tooltip); }, 2000);
                }

                window.addEventListener('resize', function() {
                    if (vantaEffect) vantaEffect.resize();
                    globe.width(container.offsetWidth);
                    globe.height(container.offsetHeight);
                });

                setTimeout(function() {
                    globe.pointOfView({ lat: 30, lng: 100, altitude: 2.5 }, 2000);
                }, 500);
            } catch (err) {
                console.warn("Globe.gl failed to initialize:", err);
                container.innerHTML = '<p style="text-align:center;padding:20px;font-size:0.9rem;color:var(--subtitle-color);">Interactive globe unavailable on this device.</p>';
            }
        }
    }

    // ============================================
    // COUNTER ANIMATIONS
    // ============================================
    function animateCounter(id, target, duration) {
        if (!duration) duration = 2000;
        var el = document.getElementById(id);
        if (!el) return;
        var startTime = performance.now();
        function easeOutGentle(t) { return Math.pow(t, 0.74); }
        function update(currentTime) {
            var elapsed = currentTime - startTime;
            var progress = Math.min(elapsed / duration, 1);
            var easedProgress = easeOutGentle(progress);
            var currentValue = Math.floor(easedProgress * target);
            el.textContent = currentValue;
            if (progress < 1) {
                requestAnimationFrame(update);
            } else {
                el.textContent = target;
            }
        }
        requestAnimationFrame(update);
    }

    var statsSection = document.querySelector('.globe-section');
    var countersStarted = false;
    function startCounters() {
        if (countersStarted) return;
        countersStarted = true;
        animateCounter('countries-counter', 21, 2000);
        animateCounter('ski-counter', 25, 2000);
        animateCounter('dives-counter', 65, 2000);
    }

    if (statsSection) {
        if (window.IntersectionObserver) {
            var observer = new IntersectionObserver(function(entries) {
                entries.forEach(function(entry) {
                    if (entry.isIntersecting) {
                        startCounters();
                        observer.disconnect();
                    }
                });
            }, { threshold: 0.5, rootMargin: '0px' });
            requestAnimationFrame(function() { observer.observe(statsSection); });
        } else {
            startCounters();
        }
    }

    // ============================================
    // TIMELINE ACCORDION
    // ============================================
    var timeline = document.getElementById('timeline');
    if (timeline) {
        var items = timeline.querySelectorAll('.timeline-item');
        var vantaResetTimer = null;
        
        function updateVantaColor(item) {
            if (!vantaEffect) return;
            
            var colors = vantaColors.default;
            if (item && item.classList.contains('expanded')) {
                if (item.classList.contains('current')) colors = vantaColors.current;
                else if (item.classList.contains('research')) colors = vantaColors.research;
                else if (item.classList.contains('education')) colors = vantaColors.education;
            }
            
            animateVantaColors(colors, 800); // 800ms smooth transition
        }

        function startInactivityTimer() {
            if (vantaResetTimer) clearTimeout(vantaResetTimer);
            vantaResetTimer = setTimeout(function() {
                for (var m = 0; m < items.length; m++) { 
                    if (items[m]) items[m].classList.remove('expanded'); 
                }
                updateVantaColor(null);
            }, 10000);
        }

        for (var k = 0; k < items.length; k++) {
            (function(item) {
                item.addEventListener('click', function() {
                    var wasExpanded = item.classList.contains('expanded');
                    
                    if (vantaResetTimer) clearTimeout(vantaResetTimer);

                    // Close all
                    for (var m = 0; m < items.length; m++) { 
                        if (items[m]) items[m].classList.remove('expanded'); 
                    }
                    
                    if (!wasExpanded) {
                        item.classList.add('expanded');
                        updateVantaColor(item);
                        startInactivityTimer();
                    } else {
                        updateVantaColor(null);
                    }
                });
            })(items[k]);
        }

        // Initialize color for initially expanded item
        var initialExpanded = timeline.querySelector('.timeline-item.expanded');
        if (initialExpanded) {
            updateVantaColor(initialExpanded);
            startInactivityTimer();
        }
    }

    // ============================================
    // NEWS ARTICLES
    // ============================================
    var newsArticles = [
      {title:'Researchers find that race matters in recovery after cancer surgery', url:'https://www.uhnresearch.ca/news/race-matters-recovery'},
      {title:'Toronto entrepreneurs win medtech pitch competition', url:'https://www.ideation.clinic/news/challenge-winner-specifix'},
      {title:'Anesthesia Resident Receives Two Awards at International Meeting', url:'https://anesthesia.utoronto.ca/news/anesthesia-resident-receives-two-awards-society-neuroscience-anesthesiology-and-critical-care'}
    ];
    var API_KEY = '9a71cb507a453d96a0e0c017e1f7ec00';

    function renderNews() {
      var newsContainer = document.getElementById('news-grid');
      if (!newsContainer) return;
      
      for (var n = 0; n < newsArticles.length; n++) {
        (function(article) {
          fetch('https://api.linkpreview.net/?key=' + API_KEY + '&q=' + encodeURIComponent(article.url))
            .then(function(res) { return res.json(); })
            .then(function(preview) {
              // Always show the article, even if image or metadata is missing
              var title = (preview && preview.title) ? preview.title : article.title;
              var url = (preview && preview.url) ? preview.url : article.url;
              // Fallback to a default image if none found
              var image = (preview && preview.image) ? preview.image : 'images/pic01.jpg';
              
              var div = document.createElement('div');
              div.className = 'news-card';
              div.innerHTML = '<a href="' + url + '" target="_blank" rel="noopener">' +
                              '<img src="' + image + '" alt="' + title + '">' +
                              '<p>' + title + '</p></a>';
              newsContainer.appendChild(div);
            })
            .catch(function(e) { 
              console.error('Error fetching preview for ' + article.url + ':', e);
              // Fallback for network error or API failure
              var div = document.createElement('div');
              div.className = 'news-card';
              div.innerHTML = '<a href="' + article.url + '" target="_blank" rel="noopener">' +
                              '<img src="images/pic01.jpg" alt="' + article.title + '">' +
                              '<p>' + article.title + '</p></a>';
              newsContainer.appendChild(div);
            });
        })(newsArticles[n]);
      }
    }
    renderNews();

    // ============================================
    // PUBLICATIONS
    // ============================================
    var allWorks = []; // Global store for works data

    function updateShowMoreButton() {
        var pubList = document.getElementById("pub-list");
        var showMoreContainer = document.getElementById("show-more-container");
        if (!pubList || !showMoreContainer) return;
        var entries = pubList.querySelectorAll('.pub-entry-container');
        if (entries.length > 10) {
            showMoreContainer.style.display = "block";
        } else {
            showMoreContainer.style.display = "none";
        }
    }

    function reconstructAbstract(work) {
        if (!work) return null;
        if (work.abstract) return work.abstract; // Some works have raw text
        var invertedIndex = work.abstract_inverted_index;
        if (!invertedIndex) return null;
        var words = [];
        for (var word in invertedIndex) {
            var positions = invertedIndex[word];
            for (var j = 0; j < positions.length; j++) {
                words[positions[j]] = word;
            }
        }
        return words.join(' ');
    }

    window.openPreview = function(index) {
        console.log('Opening preview for index:', index);
        var work = allWorks[index];
        if (!work) {
            console.error('Work not found at index:', index);
            return;
        }

        var modal = document.getElementById('paper-modal');
        var title = document.getElementById('modal-title');
        var authors = document.getElementById('modal-authors');
        var journal = document.getElementById('modal-journal');
        var abstract = document.getElementById('modal-abstract');
        var link = document.getElementById('modal-link');
        var abstractContainer = document.getElementById('modal-abstract-container');

        if (!modal) {
            console.error('Modal element not found');
            return;
        }

        title.innerText = work.title || 'Untitled';
        
        var authorsArr = (work.authorships || []).map(function(a) {
            return (a.author && a.author.display_name) ? a.author.display_name : 'Unknown Author';
        });
        authors.innerText = authorsArr.join(', ');
        
        var journalName = (work.primary_location && work.primary_location.source && work.primary_location.source.display_name) ? work.primary_location.source.display_name : '';
        var year = work.publication_year || '';
        journal.innerHTML = '<em>' + journalName + '</em>' + (year ? ' (' + year + ')' : '');

        var absText = reconstructAbstract(work);
        
        if (absText) {
            abstract.innerText = absText;
        } else {
            var pmid = (work.ids && work.ids.pmid) ? work.ids.pmid.split('/').pop() : null;
            var doi = work.doi ? work.doi.replace('https://doi.org/', '') : null;
            
            var msg = '<div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:10px; border-left:4px solid #ff6b6b; margin-top:10px;">' +
                      '<p>The abstract for this work is not currently indexed in our primary open database.</p>';
            
            if (pmid) {
                msg += '<p style="margin-top:15px;"><a href="https://pubmed.ncbi.nlm.nih.gov/' + pmid + '/" target="_blank" rel="noopener" style="color:#ff6b6b; font-weight:600; text-decoration:underline;">Read the full abstract on PubMed ‚Üí</a></p>';
            } else if (entryLink) {
                msg += '<p style="margin-top:15px;"><a href="' + entryLink + '" target="_blank" rel="noopener" style="color:#ff6b6b; font-weight:600; text-decoration:underline;">Read the abstract on the publisher\'s site ‚Üí</a></p>';
            }
            
            msg += '</div>';
            abstract.innerHTML = msg;
        }
        
        var pmidId = (work.ids && work.ids.pmid) ? work.ids.pmid : null;
        var entryLink = pmidId || work.doi || work.id;
        link.href = entryLink;

        // Reset view
        abstractContainer.style.display = 'block';

        modal.style.display = 'block';
        
    // Ensure scroll starts at the top
    var scrollWrapper = document.getElementById('modal-scroll-wrapper');
    if (scrollWrapper) {
        scrollWrapper.scrollTop = 0;
        
        // iOS Scroll Chaining Fix: Prevent reaching absolute boundaries
        scrollWrapper.addEventListener('touchstart', function() {
            var top = scrollWrapper.scrollTop,
                totalScroll = scrollWrapper.scrollHeight,
                currentScroll = top + scrollWrapper.offsetHeight;

            if (top === 0) {
                scrollWrapper.scrollTop = 1;
            } else if (currentScroll === totalScroll) {
                scrollWrapper.scrollTop = top - 1;
            }
        });
    }
        
        document.body.style.overflow = 'hidden'; // Prevent scroll
    };

    window.closePreview = function() {
        var modal = document.getElementById('paper-modal');
        if (modal) modal.style.display = 'none';
        document.body.style.overflow = '';
    };

    // Modal close events
    var closeBtn = document.querySelector('.close-modal');
    if (closeBtn) {
        closeBtn.onclick = closePreview;
        closeBtn.addEventListener('touchstart', function(e) {
            e.preventDefault();
            closePreview();
        }, {passive: false});
    }

    window.onclick = function(event) {
        var modal = document.getElementById('paper-modal');
        if (event.target == modal) closePreview();
    };
    
    // Add touchstart for closing when clicking outside on mobile
    window.addEventListener('touchstart', function(event) {
        var modal = document.getElementById('paper-modal');
        if (event.target == modal) {
            event.preventDefault();
            closePreview();
        }
    }, {passive: false});

    function loadPublications(forceRefresh) {
        if (forceRefresh === undefined) forceRefresh = false;
        var cacheKey = "pub_cache_html_v16";
        var cacheDataKey = "pub_cache_data_v16";
        var cacheTimeKey = "pub_cache_time_v16";
        var orcid = "0000-0003-4482-4792";
        var pubListEl = document.getElementById("pub-list");
        if (!pubListEl) return;

        var now = Date.now();
        var cachedHtml = storageAvailable ? localStorage.getItem(cacheKey) : null;
        var cachedData = storageAvailable ? localStorage.getItem(cacheDataKey) : null;
        var cachedTime = storageAvailable ? parseInt(localStorage.getItem(cacheTimeKey) || "0", 10) : 0;
        
        if (!forceRefresh && cachedHtml && cachedData && cachedTime && (now - cachedTime < 86400000)) {
            try {
                allWorks = JSON.parse(cachedData);
                pubListEl.innerHTML = cachedHtml;
                var timeEl = document.getElementById("last-updated-time");
                if (timeEl) timeEl.innerText = new Date(cachedTime).toLocaleString();
                updateShowMoreButton();
                return;
            } catch (e) {
                // Ignore and refetch
            }
        }

        pubListEl.innerHTML = '<div style="padding:20px; text-align:center;">Updating publications...</div>';

        var filter = 'author.orcid:https://orcid.org/' + orcid;
        var apiUrl = 'https://api.openalex.org/works?filter=' + encodeURIComponent(filter) + '&sort=publication_year:desc,publication_date:desc&per_page=100';

        fetch(apiUrl)
            .then(function(res) { 
                if (!res.ok) throw new Error('API response not OK: ' + res.status);
                return res.json(); 
            })
            .then(function(data) {
                var works = data.results || [];
                allWorks = works; // Store globally
                var finalUpdateEl = document.getElementById("last-updated-time");
                var nowStr = new Date().toLocaleString();
                
                if (finalUpdateEl) finalUpdateEl.innerText = nowStr;
                if (storageAvailable) {
                    localStorage.setItem(cacheTimeKey, now.toString());
                    localStorage.setItem(cacheDataKey, JSON.stringify(works));
                }

                if (!works.length) {
                    pubListEl.innerHTML = '<p>No publications found.</p>';
                    return;
                }

                var html = '';
                var counter = 1;
                for (var i = 0; i < works.length; i++) {
                    var work = works[i];
                    var type = (work.type || '').toLowerCase();
                    if (type === 'paratext' || type === 'frontmatter') continue;
                    
                    var pmidId = (work.ids && work.ids.pmid) ? work.ids.pmid : null;
                    if (!pmidId) continue;
                    
                    var doi = work.doi || null;

                    var authorsArr = (work.authorships || []).map(function(a) {
                        return (a.author && a.author.display_name) ? a.author.display_name : 'Unknown Author';
                    });
                    var authorsStr = authorsArr.length > 3 ? authorsArr.slice(0, 3).join(', ') + ', et al.' : authorsArr.join(', ');
                    var title = work.title || 'Untitled';
                    
                    var year = work.publication_year || '';
                    var journal = (work.primary_location && work.primary_location.source && work.primary_location.source.display_name) ? work.primary_location.source.display_name : '';
                    var entryLink = pmidId || doi || work.id;
                    var content = counter + '. ' + authorsStr + '. <strong>' + title + '</strong>. <em>' + journal + '</em>' + (year ? '. ' + year + '.' : '');
                    
                    html += '<div class="pub-entry-container">' +
                            '<a onclick="openPreview(' + i + ')" class="pub-entry">' + content + '</a>' +
                            '</div>';
                    counter++;
                }

                if (!html) {
                    pubListEl.innerHTML = '<p>No publications found.</p>';
                } else {
                    pubListEl.innerHTML = html;
                    if (storageAvailable) localStorage.setItem(cacheKey, html);
                }
                updateShowMoreButton();
            })
            .catch(function(err) {
                console.error('Error loading publications:', err);
                pubListEl.innerText = "Error loading publications. Please try refreshing.";
            });
    }

    function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/[&<>\"'`]/g, function(s) {
            return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '`': '&#96;' }[s];
        });
    }

    var refreshBtn = document.getElementById('refresh-btn');
    if (refreshBtn) refreshBtn.addEventListener('click', function() { loadPublications(true); });
    
    var showMoreBtn = document.getElementById('show-more-btn');
    if (showMoreBtn) {
        showMoreBtn.addEventListener('click', function() {
            var pubList = document.getElementById('pub-list');
            if (pubList.classList.contains('collapsed')) {
                pubList.classList.remove('collapsed');
                showMoreBtn.textContent = 'Show Less';
            } else {
                pubList.classList.add('collapsed');
                showMoreBtn.textContent = 'Show More';
                document.getElementById('publications').scrollIntoView({ behavior: 'smooth' });
            }
        });
    }

    loadPublications();

    var contactLink = document.getElementById('contact-link');
    if (contactLink) {
        contactLink.addEventListener('click', function(e) {
            e.preventDefault();
            var u = 'alex.bak', d = 'mail.utoronto.ca';
            window.location.href = 'mailto:' + u + '@' + d;
        });
    }
});
</script>
</body>
</html>
